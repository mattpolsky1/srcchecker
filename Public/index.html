<!DOCTYPE html>
<html>

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-L45Z9JYDS2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'G-L45Z9JYDS2');
    </script>
    <title>Gym Attendance</title>
    <style>
        body {
            font-family: 'Gotham Bold', Arial, sans-serif;
            background-color: #b6d0e8;
            text-align: center;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            position: relative;
        }

        h1 {
            font-size: 72px;
            /* Larger font size */
            font-weight: bold;
            color: #295296;
        }

        #peopleAtGym {
            font-size: 100px;
            /* Larger font size */
            font-weight: bold;
            color: #295296;
            text-align: center;
            margin-bottom: 20px;
        }

        #status {
            font-size: 24px;
            /* Larger font size */
            font-weight: bold;
            color: #5b5857;
            position: absolute;
            top: 10px;
            right: 10px;
        }

        #gymStatus {
            font-size: 36px;
            /* Adjusted font size */
            font-weight: bold;
            color: #295296;
            text-align: center;
            /* Center the text */
            margin-top: 20px;
        }

        button.checkIn {
            font-size: 48px;
            /* Larger font size for mobile */
            font-weight: bold;
            padding: 30px 60px;
            /* Larger button size */
            background-color: #295296;
            color: #fff;
            border: none;
            cursor: pointer;
            margin-top: 30px;
            display: block;
        }

        button.checkIn.hidden {
            display: none;
            /* Hide the button */
        }

        button.checkOut {
            font-size: 48px;
            font-weight: bold;
            padding: 30px 60px;
            background-color: #FF5733;
            color: #fff;
            border: none;
            cursor: pointer;
            margin-top: 30px;
            display: block;
        }

        button:hover {
            background-color: #0056b3;
        }

        #logo {
            font-size: 14px;
            font-weight: bold;
            position: fixed;
            bottom: 0;
            left: 0;
            color: #5b5857;
        }

        /* Style to position the image at the bottom left */
        #logo img {
            width: 250px;
            /* Slightly larger logo */
            height: auto;
        }

        /* Media query for small screens (mobile devices) */
        @media screen and (max-width: 768px) {
            #peopleAtGym {
                font-size: 72px;
                /* Larger font size */
            }

            #status {
                font-size: 24px;
                /* Larger font size */
                position: static;
            }

            #gymStatus {
                font-size: 30px;
                /* Adjusted font size */
            }
        }
    </style>
</head>

<body>
    <h1>People at the Gym: <span id="peopleAtGym">0</span></h1>
    <div id="status">Status: <span id="statusLabel">Checked Out</span></div>
    <div id="gymStatus">Gym Status: <span id="gymStatusLabel">Empty</span></div>
    <button id="toggleCheckInButton" class="checkIn">Check In</button>
    <div id="logo">
        <img id="myImage" src="https://i.ibb.co/gPhHQ7f/campushoopslogo-02.png" alt="campushoopslogo-02">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/3.0.1/js.cookie.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        let isRefreshing = false;

        // Listen for beforeunload event
        // Listen for page unload
        window.addEventListener('beforeunload', (event) => {
            console.log('Beforeunload event triggered');
            if (!isRefreshing && checkedIn) {
                navigator.sendBeacon('/beacon', JSON.stringify({ checkedIn }));
            }
        });

        // Listen for page visibility change
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                isRefreshing = true;
            } else {
                isRefreshing = false;
            }
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);

                    if (registration.active) {
                        registration.active.postMessage({
                            type: 'start',
                            checkedIn: checkedIn,
                        });
                    } else {
                        console.error('Service Worker controller is null.');
                    }
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
        }

        if ('serviceWorker' in navigator && 'SyncManager' in window) {
            navigator.serviceWorker.ready.then((registration) => {
                // Register for background sync
                registration.sync.register('autoCheckOut');
            });
        }

        const peopleAtGymElement = document.getElementById("peopleAtGym");
        const toggleCheckInButton = document.getElementById("toggleCheckInButton");
        const statusLabel = document.getElementById("statusLabel");
        const gymStatusLabel = document.getElementById("gymStatusLabel");

        const socket = io();

        let checkedIn = false;
        const cookieKey = "checkInStatus";

        function resumeTimer() {
            const checkInTimestamp = Cookies.get('checkInTimestamp');
            if (checkInTimestamp) {
                const currentTime = Date.now();
                const timeElapsed = currentTime - parseInt(checkInTimestamp, 10);
                const remainingTime = 30000 - timeElapsed; // 30 seconds - time elapsed
                if (remainingTime > 0) {
                    checkedIn = true;
                    setTimeout(autoCheckOut, remainingTime);
                    toggleButtonVisibility(); // Hide the button
                } else {
                    Cookies.remove('checkInTimestamp');
                    checkedIn = false;
                    updateStatus("Checked Out");
                    toggleButtonVisibility(); // Show the button
                }
            }
        }

        const previousCheckInStatus = Cookies.get(cookieKey);
        if (previousCheckInStatus === "checkedIn") {
            checkedIn = true;
            toggleCheckInButton.classList.add("hidden"); // Hide the button
            updateStatus("Checked In");
            resumeTimer(); // Resume the timer if applicable
        }

        function initializeCheckIn() {
            const { status, timestamp } = getCheckInStatusFromCookie();

            if (status === "checkedIn") {
                checkedIn = true;
                updateStatus("Checked In");
                toggleButtonVisibility(); // Hide the button

                const currentTime = Date.now();
                const timeElapsed = currentTime - parseInt(timestamp, 10);
                const remainingTime = 30000 - timeElapsed; // 30 seconds - time elapsed

                if (remainingTime > 0) {
                    setTimeout(autoCheckOut, remainingTime);
                } else {
                    Cookies.remove('checkInTimestamp');
                    checkedIn = false;
                    updateStatus("Checked Out");
                    toggleButtonVisibility(); // Show the button
                }
            } else {
                checkedIn = false;
                updateStatus("Checked Out");
                toggleButtonVisibility(); // Show the button
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            socket.emit('requestCheckInStatus');
            socket.on('responseCheckInStatus', (checkInStatus) => {
                initializeCheckIn(); // Initialize check-in status and timer if applicable
            });
        });

        socket.on('removeCheckedOutAutomaticallyFlag', () => {
            Cookies.remove('checkedOutAutomatically');
        });

        socket.on('dailyCheckIns', (data) => {
            console.log(`Number of check-ins on ${data.date.toDateString()}: ${data.count}`);
        });

        // Event listener for hourly check-ins
        socket.on('hourlyCheckIns', (data) => {
            console.log(`Number of check-ins this hour (${data.hour}:00 - ${data.hour + 1}:00): ${data.count}`);
        });

        // Check for stored check-in status and timestamp on page load
        const { status, timestamp } = getCheckInStatusFromCookie();
        if (status === "checkedIn") {
            checkedIn = true;
            updateStatus("Checked In");
            toggleButtonVisibility(); // Hide the button
            // Set a timer to automatically check out after 30 seconds
            setTimeout(autoCheckOut, 30000); // 30 seconds
        }

        let checkInButtonVisible = true; // Track the visibility of the button

        // Function to toggle the button's visibility
        function toggleButtonVisibility() {
            const button = document.getElementById("toggleCheckInButton");
            if (checkedIn) {
                button.style.display = "none"; // Hide the button
            } else {
                button.style.display = "block"; // Show the button
            }
        }

        function setCheckInStatusInCookie(status, timestamp) {
            Cookies.set(cookieKey, status);
            Cookies.set('checkInTimestamp', timestamp);
        }

        function getCheckInStatusFromCookie() {
            const status = Cookies.get(cookieKey);
            const timestamp = Cookies.get('checkInTimestamp');
            return { status, timestamp };
        }

        navigator.serviceWorker.addEventListener('message', (event) => {
            const { type } = event.data;
            if (type === 'tick') {
                // Handle the tick event, update the UI if needed
            } else if (type === 'autoCheckOut') {
                // Handle the auto-checkout event
                autoCheckOut();
            }
        });

        function autoCheckOut() {
            console.log('Auto checkout function called!');
            if (checkedIn) {
                checkedIn = false;
                updateStatus("Checked Out");
                toggleButtonVisibility(); // Show the button
                Cookies.remove(cookieKey);
                Cookies.remove('checkInTimestamp');
                socket.emit('checkOut');
                Cookies.set('checkedOutAutomatically', 'true');
            }
        }

        // Event listener for the Check-In button
        toggleCheckInButton.addEventListener("click", () => {
            if (!checkedIn) {
                const currentTime = Date.now();
                checkedIn = true;
                Cookies.set("checkInStatus", "checkedIn");
                updateStatus("Checked In");
                toggleButtonVisibility(); // Hide the button immediately

                // Store check-in status and timestamp in cookies
                setCheckInStatusInCookie("checkedIn", currentTime);

                // Set a timer to automatically check out after 30 seconds
                setTimeout(autoCheckOut, 30000); // 30 seconds

                socket.emit('checkIn');
            }
        });

        socket.on('initCount', (count) => {
            updateCount(count);
        });

        socket.on('updateCount', (count) => {
            updateCount(count);
        });

        socket.on('checkInNotAllowed', () => {
            alert('You are not within 10 miles of the specified location. Check-in not allowed.');
        });

        socket.on('checkedOutAutomatically', () => {
            alert('You have been checked out automatically after 30 seconds of inactivity.');
            checkedIn = false;
            Cookies.remove("checkInStatus");
            updateStatus("Checked Out");
            toggleCheckInButton.classList.remove("hidden"); // Show the button
        });

        function updateCount(count) {
            peopleAtGymElement.textContent = count;
            if (count > 50) {
                gymStatusLabel.textContent = "Packed";
                gymStatusLabel.style.color = "#FF5733"; // Red color
            } else {
                gymStatusLabel.textContent = "Empty";
                gymStatusLabel.style.color = "#295296"; // Blue color
            }
        }

        function updateStatus(status) {
            statusLabel.textContent = status;
            statusLabel.style.color = status === "Checked In" ? "#295296" : "#FF5733"; // Blue for Checked In, Red for Checked Out
        }
    </script>
</body>

</html>
