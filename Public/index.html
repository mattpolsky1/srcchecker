<!DOCTYPE html>
<html>
<head>
    <title>Gym Attendance</title>
    <style>
        body {
            font-family: 'Gotham Bold', Arial, sans-serif;
            background-color: #b6d0e8;
            text-align: center;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            position: relative;
        }

        h1 {
            font-size: 72px; /* Larger font size */
            font-weight: bold;
            color: #295296;
        }

        #peopleAtGym {
            font-size: 100px; /* Larger font size */
            font-weight: bold;
            color: #295296;
            text-align: center;
            margin-bottom: 20px;
        }

        #status {
            font-size: 24px; /* Larger font size */
            font-weight: bold;
            color: #5b5857;
            position: absolute;
            top: 10px;
            right: 10px;
        }

        #gymStatus {
            font-size: 36px; /* Adjusted font size */
            font-weight: bold;
            color: #295296;
            text-align: center; /* Center the text */
            margin-top: 20px;
        }

        button.checkIn {
            font-size: 48px; /* Larger font size for mobile */
            font-weight: bold;
            padding: 30px 60px; /* Larger button size */
            background-color: #295296;
            color: #fff;
            border: none;
            cursor: pointer;
            margin-top: 30px;
            display: block;
        }

        button.checkIn.hidden {
            display: none; /* Hide the button */
        }

        button.checkOut {
            font-size: 48px;
            font-weight: bold;
            padding: 30px 60px;
            background-color: #FF5733;
            color: #fff;
            border: none;
            cursor: pointer;
            margin-top: 30px;
            display: block;
        }

        button:hover {
            background-color: #0056b3;
        }

        #logo {
            font-size: 14px;
            font-weight: bold;
            position: fixed;
            bottom: 0;
            left: 0;
            color: #5b5857;
        }

        /* Style to position the image at the bottom left */
        #logo img {
            width: 250px; /* Slightly larger logo */
            height: auto;
        }

        /* Media query for small screens (mobile devices) */
        @media screen and (max-width: 768px) {
            #peopleAtGym {
                font-size: 72px; /* Larger font size */
            }

            #status {
                font-size: 24px; /* Larger font size */
                position: static;
            }

            #gymStatus {
                font-size: 30px; /* Adjusted font size */
            }
        }
    </style>
</head>
<body>
<h1>People at the Gym: <span id="peopleAtGym">0</span></h1>
<div id="status">Status: <span id="statusLabel">Checked Out</span></div>
<div id="gymStatus">Gym Status: <span id="gymStatusLabel">Empty</span></div>
<button id="toggleCheckInButton" class="checkIn">Check In</button>
<div id="logo">
    <img id="myImage" src="https://i.ibb.co/gPhHQ7f/campushoopslogo-02.png" alt="campushoopslogo-02">
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBrWbBamD1cA1NL9Q3Mt1Izml4WwZlzncs&libraries=geometry&callback=initMap"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/3.0.1/js.cookie.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
    const peopleAtGymElement = document.getElementById("peopleAtGym");
    const toggleCheckInButton = document.getElementById("toggleCheckInButton");
    const statusLabel = document.getElementById("statusLabel");
    const gymStatusLabel = document.getElementById("gymStatusLabel");

    const socket = io();

    let checkedIn = false;
const localStorageKey = "checkInStatus";

// Check if the user has previously checked in
function resumeTimer() {
        const checkInTimestamp = localStorage.getItem('checkInTimestamp');
        if (checkInTimestamp) {
            const currentTime = Date.now();
            const timeElapsed = currentTime - parseInt(checkInTimestamp, 10);
            const remainingTime = 30000 - timeElapsed; // 30 seconds - time elapsed
            if (remainingTime > 0) {
                checkedIn = true;
                setTimeout(autoCheckOut, remainingTime);
                toggleButtonVisibility(); // Hide the button
            } else {
                // Timer has expired, check the user out
                localStorage.removeItem('checkInTimestamp');
                checkedIn = false;
                updateStatus("Checked Out");
                toggleButtonVisibility(); // Show the button
            }
        }
    }

    // Check if the user has previously checked in
    const previousCheckInStatus = localStorage.getItem(localStorageKey);
    if (previousCheckInStatus === "checkedIn") {
        checkedIn = true;
        toggleCheckInButton.classList.add("hidden"); // Hide the button
        updateStatus("Checked In");
        resumeTimer(); // Resume the timer if applicable
    }

    // Event listener for when the page is fully loaded
    document.addEventListener("DOMContentLoaded", () => {
        // Request the user's check-in status from the server
        socket.emit('requestCheckInStatus');

        // Event listener for when the server responds with the user's check-in status
        socket.on('responseCheckInStatus', (checkInStatus) => {
            if (checkInStatus === "checkedIn") {
                checkedIn = true;
                toggleCheckInButton.classList.add("hidden"); // Hide the button
                updateStatus("Checked In");
                resumeTimer(); // Resume the timer if applicable
            }
        });
    });

    socket.on('dailyCheckIns', (data) => {
    console.log(`Number of check-ins on ${data.date.toDateString()}: ${data.count}`);
});

// Event listener for hourly check-ins
socket.on('hourlyCheckIns', (data) => {
    console.log(`Number of check-ins this hour (${data.hour}:00 - ${data.hour + 1}:00): ${data.count}`);
});

    // Check for stored check-in status and timestamp on page load
    const { status, timestamp } = getCheckInStatusFromCookie();
    if (status === "checkedIn") {
        checkedIn = true;
        updateStatus("Checked In");
        toggleButtonVisibility(); // Hide the button
        // Set a timer to automatically check out after 30 seconds
        setTimeout(autoCheckOut, 30000); // 30 seconds
    }

let checkInButtonVisible = true; // Track the visibility of the button

// Function to toggle the button's visibility
function toggleButtonVisibility() {
    const button = document.getElementById("toggleCheckInButton");
    if (checkInButtonVisible) {
        button.style.display = "none"; // Hide the button
    } else {
        button.style.display = "block"; // Show the button
    }
    checkInButtonVisible = !checkInButtonVisible; // Toggle the visibility flag
}

// Function to store check-in status and timestamp in cookies
function setCheckInStatusInCookie(status, timestamp) {
    Cookies.set('checkInStatus', status);
    Cookies.set('checkInTimestamp', timestamp);
}

// Function to get check-in status and timestamp from cookies
function getCheckInStatusFromCookie() {
    const status = Cookies.get('checkInStatus');
    const timestamp = Cookies.get('checkInTimestamp');
    return { status, timestamp };
}

// Function to automatically check out the user after 30 seconds
function autoCheckOut() {
    if (checkedIn) {
        checkedIn = false;
        updateStatus("Checked Out");
        toggleButtonVisibility(); // Show the button
        // Remove check-in status and timestamp cookies
        Cookies.remove('checkInStatus');
        Cookies.remove('checkInTimestamp');
        
        // Notify the server about the check-out
        socket.emit('checkOut');
    }
}

// Event listener for the Check-In button
toggleCheckInButton.addEventListener("click", () => {
    if (!checkedIn) {
        const currentTime = Date.now();
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
                const userLatitude = position.coords.latitude;
                const userLongitude = position.coords.longitude;
                const targetLocation = { latitude: 35.90927, longitude: -79.04746 };
                const distance = getDistance({ latitude: userLatitude, longitude: userLongitude }, targetLocation);

                if (distance <= 10000) { // Within 10 miles
                    checkedIn = true;
                    localStorage.setItem(localStorageKey, "checkedIn");
                    updateStatus("Checked In");
                    toggleButtonVisibility(); // Hide the button immediately

                    // Store check-in status and timestamp in cookies
                    setCheckInStatusInCookie("checkedIn", currentTime);

                    // Set a timer to automatically check out after 30 seconds
                    setTimeout(autoCheckOut, 30000); // 30 seconds

                    socket.emit('checkIn', { latitude: userLatitude, longitude: userLongitude });
                } else {
                    alert("You are not within 10 miles of the specified location. Check-in not allowed.");
                }
            }, (error) => {
                console.error('Error getting user location:', error);
                alert('Error getting your location. Please check your web settings and try again.');
            });
        } else {
            alert('Geolocation is not supported by your browser.');
        }
    }
});

    socket.on('updateCount', (count) => {
        updateCount(count);
    });

    socket.on('checkInNotAllowed', () => {
        alert('You are not within 10 miles of the specified location. Check-in not allowed.');
    });

    socket.on('checkedOutAutomatically', () => {
        alert('You have been checked out automatically after 30 seconds of inactivity.');
        checkedIn = false;
        localStorage.removeItem(localStorageKey);
        updateStatus("Checked Out");
        toggleCheckInButton.classList.remove("hidden"); // Show the button
    });

    function updateCount(count) {
        peopleAtGymElement.textContent = count;
        if (count > 50) {
            gymStatusLabel.textContent = "Packed";
            gymStatusLabel.style.color = "#FF5733"; // Red color
        } else {
            gymStatusLabel.textContent = "Empty";
            gymStatusLabel.style.color = "#295296"; // Blue color
        }
    }

    function updateStatus(status) {
        statusLabel.textContent = status;
        statusLabel.style.color = status === "Checked In" ? "#295296" : "#FF5733"; // Blue for Checked In, Red for Checked Out
    }

    // Haversine formula to calculate distance between two points on the Earth's surface
    function getDistance(location1, location2) {
        const R = 6371; // Radius of the Earth in kilometers
        const lat1 = location1.latitude;
        const lon1 = location1.longitude;
        const lat2 = location2.latitude;
        const lon2 = location2.longitude;

        const dLat = toRadians(lat2 - lat1);
        const dLon = toRadians(lon2 - lon1);

        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);

        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        const distance = R * c; // Distance in kilometers

        return distance * 1000; // Convert to meters
    }

    // Function to convert degrees to radians
    function toRadians(degrees) {
        return degrees * (Math.PI / 180);
    }
</script>
</body>
</html>